<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>第九章 虚拟内存</title>
	</head>
	<body>
		<h1>第九章 虚拟内存</h1>
		<div>
			为了更加有效地管理内存并且少出错，现代系统提供了一种对主存的抽象概念，叫做虚拟内存(VM)。<br />
			虚拟内存提供了三个重要的能力:<br />
			1)它将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据，通过这种方式，它高效地使用了主存。<br />
			2)它为每个进程提供了一致的地址空间，从而简化了内存管理。<br />
			3)它保护了每个进程的地址空间不被其他进程破坏。<br />
			
			<h2>物理和虚拟寻址</h2>
			<div>
				计算机系统的主存被组织成一个由M个连续的字节大小的单元组成的数组。每字节都有一个唯一的物理地址(Physical Address,PA)。第一个字节的地址为0，接下来的字节地址为1，再下一个为2，依此类推。给定这种简单的结构，
				CPU访问内存的最自然的方式就是使用物理地址。我们把这种方式称为物理寻址(physicaladdressing)。<br />
				下图展示了一个物理寻址的示例，该示例的上下文是一条加载指令，它读取从物理地址4处开始的4字节字。当CPU执行这条加载指令时，会生成一个有效物理地址，通过内存总线，把它传递给主存。主存取出从物理地址4处开始的4字
				节字，并将它返回给CPU, CPU会将它存放在一个寄存器里。<br />
				<img src="./res/1.png" />
				<br /><br />
				现代处理器使用的是一种称为虚拟寻址(virtual addressing)的寻址形式，如下图使用虚拟寻址，CPU通过生成一个虚拟地址(Virtual Address, VA)来访问主存，这个虚拟地址在被送到内存之前先转换成适当的物理地址。将一个
				虚拟地址转换为物理地址的任务叫做地址翻译(address translation)。就像异常处理一样，地址翻译需要CPU硬件和操作系统之I间的紧密合作。CPU芯片上叫做内存管理单元(Memory Management Unit,MMU)的专用硬件，利用存放
				在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理。
				<img src="./res/2.png" />
			</div>
			
			<h2>地址空间</h2>
			<div>
				地址空间(address space)是一个非负整数地址的有序集合:<br />
				{0，1，2，…}<br />
				如果地址空间中的整数是连续的，那么我们说它是一个线性地址空间(( linear addressspace)。为了简化讨论，假设使用的是线性地址空间。在一个带虚拟内存的系统中，CPU从一个有N = 2^n个地址的地址空间中生成虚拟地址，这个
				地址空间称为虚拟地址空间(virtual address space)<br />
				{0，1，2，…，N-1}<br />
				一个地址空间的大小是由表示最大地址所需要的位数来描述的。例如，一个包含N=2^n个地址的虚拟地址空间就叫做一个n位地址空间。现代系统通常支持32位或者64位虚拟地址空间。一个系统还有一个物理地址空间
				(physical address space)，对应于系统中物理内存的M个字节:<br />
				{0，1，2，…，M-1}<br />
				M不要求是2的幂，但是为了简化讨论，我们假设M= 2^m。<br />
				地址空间清楚地区分了数据对象(字节)和它们的属性(地址)。我们就可以将其推广，允许每个数据对象有多个独立的地址，其中每个地址都选自一个不同的地址空间。这就是虚拟内存的基本思想。主存中的每字节都有一个选自虚拟地址空
				间的虚拟地址和一个选自物理地址空间的物理地址。
			</div>
			
			<h2>虚拟内存作为缓存的工具</h2>
			<div>
				概念上而言，虚拟内存被组织为一个由存放在磁盘上的N个连续的字节大小的单元组成的数组。每字节都有一个唯一的虚拟地址，作为到数组的索引。磁盘上数组的内容被缓存在主存中。和存储器层次结构中其他缓存一样，磁盘(较低层)上
				的数据被分割成块，这些块作为磁盘和主存(较高层)之间的传输单元。VM系统通过将虚拟内存分割为称为虚拟页(Virtual Page, VP)的大小固定的块来处理这个问题。每个虚拟页的大小为P=2^p字节。类似地，物理内存被分割为物理页
				(Physical Page, PP)，大小也为P字节(物理页也被称为页帧( page frame) ) 。<br />
				在任意时刻，虚拟页面的集合都分为三个不相交的子集:<br />
				<li>未分配的:VM系统还未分配(或者创建)的页。未分配的块没有任何数据和它们相关联，因此也就不占用任何磁盘空间</li>
				<li>缓存的:当前已缓存在物理内存中的已分配页</li>
				<li>未缓存的:未缓存在物理内存中的已分配页</li>
				如下图的示例展示了一个有8个虚拟页的小虚拟内存。虚拟页0和3还没有被分配，因此在磁盘上还不存在。虚拟页1, 4和6被缓存在物理内存中。页2, 5和7已经被分配了，但是当前并未缓存在主存中。
				<img src="./res/3.png" />
			</div>
			
			
		</div>
	</body>
</html>
